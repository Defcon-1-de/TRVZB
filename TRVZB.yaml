blueprint:
  name: "TRVZB Kombi – HA-Regelung + TRV-AUTO (Mo–Fr/Sa–So)"
  description: >
    Kombinierter Blueprint für Sonoff TRVZB (Zigbee2MQTT):
    - Delta-Hysterese, Fensterüberwachung, Override
    - Drag&Drop-Heizzeiten über zwei Schedule-Helper (Mo–Fr / Sa–So)
    - Programmierung des internen TRVZB-Wochenplans (weekly_schedule_*)
      via MQTT und Nutzung des AUTO-Modus.
  domain: automation
  author: Patrick Kohnke
  source_url: https://www.defcon-1.de/ha_blueprints/trvzb_kombi_auto_clean.yaml

  input:
    thermostat:
      name: Thermostat (TRVZB Climate-Entity)
      selector:
        entity:
          domain: [climate]

    temperature_sensor:
      name: Externer Temperatursensor (optional)
      description: Wenn leer, wird die interne Temperatur des Thermostats genutzt.
      default: []
      selector:
        entity:
          domain: [sensor]

    window_sensor:
      name: Fenstersensor (optional)
      description: Fenster offen = Absenkung auf Fenster-Temperatur.
      default: []
      selector:
        entity:
          domain:
            - binary_sensor
            - group

    override_entity:
      name: Override (optional)
      description: Schalter für manuelle Regelung (Blueprint-Logik pausiert).
      default: []
      selector:
        entity:
          domain:
            - input_boolean
            - switch

    last_setpoint_store:
      name: Speicher für letztes Komfort-Setpoint (optional)
      description: input_number zur Ablage des letzten Komfort-Setpoints.
      default: []
      selector:
        entity:
          domain: [input_number]

    comfort_temp:
      name: Komfort-Temperatur (°C)
      default: 21.0
      selector:
        number:
          min: 4.0
          max: 30.0
          step: 0.5
          unit_of_measurement: °C

    setback_temp:
      name: Absenktemperatur außerhalb Heizzeiten (°C)
      default: 17.0
      selector:
        number:
          min: 4.0
          max: 30.0
          step: 0.5
          unit_of_measurement: °C

    window_off_temp:
      name: Temperatur bei Fenster offen (°C)
      default: 5.0
      selector:
        number:
          min: 0.0
          max: 15.0
          step: 0.5
          unit_of_measurement: °C

    delta_hysteresis:
      name: Delta-Hysterese (°C)
      description: Komfort-Soll minus Ist, ab der geheizt wird.
      default: 3.0
      selector:
        number:
          min: 0.5
          max: 10.0
          step: 0.5
          unit_of_measurement: °C

    window_open_delay:
      name: Verzögerung Fenster auf
      default: 00:00:15
      selector:
        duration: {}

    window_close_delay:
      name: Verzögerung Fenster zu
      default: 00:01:15
      selector:
        duration: {}

    schedule_mo_fr:
      name: Heiz-Zeitplan Mo–Fr (Schedule-Helper)
      description: Drag&Drop-Zeitplan für Komfortzeiten Montag bis Freitag.
      default: []
      selector:
        entity:
          domain: [schedule]

    schedule_sa_so:
      name: Heiz-Zeitplan Sa–So (Schedule-Helper)
      description: Drag&Drop-Zeitplan für Komfortzeiten Samstag & Sonntag.
      default: []
      selector:
        entity:
          domain: [schedule]

    use_trv_auto:
      name: TRV internen AUTO-Plan nutzen
      description: >
        Wenn aktiviert, wird der interne Wochenplan des TRVZB aus den Schedule-Helpern
        programmiert (per schedule.get_schedule) und der TRV auf AUTO gesetzt.
        Fenster-/Override-Logik greift temporär ein und kehrt zu AUTO zurück.
      default: false
      selector:
        boolean: {}

    mqtt_topic_trv:
      name: MQTT-Topic des TRVZB (zigbee2mqtt)
      description: Basis-Topic für das TRVZB, z.B. "zigbee2mqtt/Wohnzimmer".
      default: zigbee2mqtt/Wohnzimmer
      selector:
        text: {}

    reprogram_button:
      name: Manuelle Neu-Programmierung (optional)
      description: input_button, um den TRV-Zeitplan manuell neu zu schreiben.
      default: []
      selector:
        entity:
          domain: [input_button]

mode: single

triggers:
  - trigger: state
    entity_id: !input temperature_sensor
    id: temp_ext

  - trigger: state
    entity_id: !input thermostat
    id: temp_int

  - trigger: state
    entity_id: !input window_sensor
    id: window

  - trigger: state
    entity_id: !input override_entity
    id: override

  - trigger: time_pattern
    minutes: /10
    id: periodic

  - trigger: state
    entity_id: !input schedule_mo_fr
    id: schedule_mo_fr

  - trigger: state
    entity_id: !input schedule_sa_so
    id: schedule_sa_so

  - trigger: state
    entity_id: !input reprogram_button
    id: reprogram_button

  - trigger: homeassistant
    event: start
    id: ha_start

variables:
  thermostat: !input thermostat
  temperature_sensor: !input temperature_sensor
  window_sensor: !input window_sensor
  override_entity: !input override_entity
  last_setpoint_store: !input last_setpoint_store
  comfort_temp: !input comfort_temp
  setback_temp: !input setback_temp
  window_off_temp: !input window_off_temp
  delta_hysteresis: !input delta_hysteresis
  window_open_delay: !input window_open_delay
  window_close_delay: !input window_close_delay
  schedule_mo_fr: !input schedule_mo_fr
  schedule_sa_so: !input schedule_sa_so
  use_trv_auto: !input use_trv_auto
  mqtt_topic_trv: !input mqtt_topic_trv

  current_temp: >
    {% if temperature_sensor != [] %}
      {{ states(temperature_sensor) | float(0) }}
    {% else %}
      {{ state_attr(thermostat, 'current_temperature') | float(0) }}
    {% endif %}

  last_comfort_temp: >
    {% if last_setpoint_store != [] %}
      {{ states(last_setpoint_store) | float(comfort_temp) }}
    {% else %}
      {{ comfort_temp }}
    {% endif %}

conditions: []

actions:
  - choose:
      # 1) TRV-Wochenplan aus Schedule-Helpern generieren & senden
      - conditions:
          - condition: template
            value_template: "{{ use_trv_auto }}"
          - condition: template
            value_template: >
              {{ trigger.id in ['schedule_mo_fr', 'schedule_sa_so', 'reprogram_button', 'ha_start'] }}
        sequence:
          - action: schedule.get_schedule
            target:
              entity_id:
                - !input schedule_mo_fr
                - !input schedule_sa_so
            response_variable: schedules

          - variables:
              comfort: "{{ comfort_temp | float }}"
              setback: "{{ setback_temp | float }}"
              max_entries: 6

              monday_str: >
                {% set ev = schedules[schedule_mo_fr]['monday'] if schedule_mo_fr != [] else [] %}
                {% set out = ['00:00/' ~ setback] %}
                {% for e in ev %}
                  {% if out|length < max_entries %}{% set _ = out.append(e.from[0:5] ~ '/' ~ comfort) %}{% endif %}
                  {% if out|length < max_entries %}{% set _ = out.append(e.to[0:5] ~ '/' ~ setback) %}{% endif %}
                {% endfor %}
                {{ out | join(' ') }}

              tuesday_str: >
                {% set ev = schedules[schedule_mo_fr]['tuesday'] if schedule_mo_fr != [] else [] %}
                {% set out = ['00:00/' ~ setback] %}
                {% for e in ev %}
                  {% if out|length < max_entries %}{% set _ = out.append(e.from[0:5] ~ '/' ~ comfort) %}{% endif %}
                  {% if out|length < max_entries %}{% set _ = out.append(e.to[0:5] ~ '/' ~ setback) %}{% endif %}
                {% endfor %}
                {{ out | join(' ') }}

              wednesday_str: >
                {% set ev = schedules[schedule_mo_fr]['wednesday'] if schedule_mo_fr != [] else [] %}
                {% set out = ['00:00/' ~ setback] %}
                {% for e in ev %}
                  {% if out|length < max_entries %}{% set _ = out.append(e.from[0:5] ~ '/' ~ comfort) %}{% endif %}
                  {% if out|length < max_entries %}{% set _ = out.append(e.to[0:5] ~ '/' ~ setback) %}{% endif %}
                {% endfor %}
                {{ out | join(' ') }}

              thursday_str: >
                {% set ev = schedules[schedule_mo_fr]['thursday'] if schedule_mo_fr != [] else [] %}
                {% set out = ['00:00/' ~ setback] %}
                {% for e in ev %}
                  {% if out|length < max_entries %}{% set _ = out.append(e.from[0:5] ~ '/' ~ comfort) %}{% endif %}
                  {% if out|length < max_entries %}{% set _ = out.append(e.to[0:5] ~ '/' ~ setback) %}{% endif %}
                {% endfor %}
                {{ out | join(' ') }}

              friday_str: >
                {% set ev = schedules[schedule_mo_fr]['friday'] if schedule_mo_fr != [] else [] %}
                {% set out = ['00:00/' ~ setback] %}
                {% for e in ev %}
                  {% if out|length < max_entries %}{% set _ = out.append(e.from[0:5] ~ '/' ~ comfort) %}{% endif %}
                  {% if out|length < max_entries %}{% set _ = out.append(e.to[0:5] ~ '/' ~ setback) %}{% endif %}
                {% endfor %}
                {{ out | join(' ') }}

              saturday_str: >
                {% set ev = schedules[schedule_sa_so]['saturday'] if schedule_sa_so != [] else [] %}
                {% set out = ['00:00/' ~ setback] %}
                {% for e in ev %}
                  {% if out|length < max_entries %}{% set _ = out.append(e.from[0:5] ~ '/' ~ comfort) %}{% endif %}
                  {% if out|length < max_entries %}{% set _ = out.append(e.to[0:5] ~ '/' ~ setback) %}{% endif %}
                {% endfor %}
                {{ out | join(' ') }}

              sunday_str: >
                {% set ev = schedules[schedule_sa_so]['sunday'] if schedule_sa_so != [] else [] %}
                {% set out = ['00:00/' ~ setback] %}
                {% for e in ev %}
                  {% if out|length < max_entries %}{% set _ = out.append(e.from[0:5] ~ '/' ~ comfort) %}{% endif %}
                  {% if out|length < max_entries %}{% set _ = out.append(e.to[0:5] ~ '/' ~ setback) %}{% endif %}
                {% endfor %}
                {{ out | join(' ') }}

          - action: mqtt.publish
            data:
              topic: "{{ mqtt_topic_trv }}/set"
              payload: >
                {
                  "weekly_schedule_monday": "{{ monday_str }}",
                  "weekly_schedule_tuesday": "{{ tuesday_str }}",
                  "weekly_schedule_wednesday": "{{ wednesday_str }}",
                  "weekly_schedule_thursday": "{{ thursday_str }}",
                  "weekly_schedule_friday": "{{ friday_str }}",
                  "weekly_schedule_saturday": "{{ saturday_str }}",
                  "weekly_schedule_sunday": "{{ sunday_str }}"
                }

          - delay: "00:00:02"

          - action: mqtt.publish
            data:
              topic: "{{ mqtt_topic_trv }}/set"
              payload: '{ "system_mode": "auto" }'

      # 2) Override: Logik pausiert
      - conditions:
          - condition: template
            value_template: >
              {{ override_entity != [] and is_state(override_entity, 'on') }}
        sequence: []

      # 3) Fenster offen
      - conditions:
          - condition: template
            value_template: >
              {{ window_sensor != [] and is_state(window_sensor, 'on') }}
        sequence:
          - delay: !input window_open_delay
          - condition: template
            value_template: >
              {{ window_sensor != [] and is_state(window_sensor, 'on') }}
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ use_trv_auto }}"
                sequence:
                  - action: climate.set_hvac_mode
                    target:
                      entity_id: !input thermostat
                    data:
                      hvac_mode: heat
                  - action: climate.set_temperature
                    target:
                      entity_id: !input thermostat
                    data:
                      temperature: !input window_off_temp
              - conditions: []
                sequence:
                  - action: climate.set_hvac_mode
                    target:
                      entity_id: !input thermostat
                    data:
                      hvac_mode: heat
                  - action: climate.set_temperature
                    target:
                      entity_id: !input thermostat
                    data:
                      temperature: !input window_off_temp

      # 4) Normalbetrieb
      - conditions:
          - condition: template
            value_template: >
              {{ override_entity == [] or is_state(override_entity, 'off') }}
        sequence:
          - choose:
              # 4a) Fenster zu
              - conditions:
                  - condition: template
                    value_template: >
                      {{ window_sensor == [] or is_state(window_sensor, 'off') }}
                sequence:
                  - choose:
                      # 4a-1) Reiner HA-Betrieb
                      - conditions:
                          - condition: template
                            value_template: "{{ not use_trv_auto }}"
                        sequence:
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: >
                                      {{ is_state(schedule_mo_fr, 'on') or
                                         is_state(schedule_sa_so, 'on') or
                                         (schedule_mo_fr == [] and schedule_sa_so == []) }}
                                sequence:
                                  - choose:
                                      - conditions:
                                          - condition: template
                                            value_template: >
                                              {{ (comfort_temp - current_temp) >= delta_hysteresis }}
                                        sequence:
                                          - choose:
                                              - conditions:
                                                  - condition: template
                                                    value_template: "{{ last_setpoint_store != [] }}"
                                                sequence:
                                                  - action: input_number.set_value
                                                    target:
                                                      entity_id: !input last_setpoint_store
                                                    data:
                                                      value: "{{ comfort_temp }}"
                                            default: []
                                          - action: climate.set_hvac_mode
                                            target:
                                              entity_id: !input thermostat
                                            data:
                                              hvac_mode: heat
                                          - action: climate.set_temperature
                                            target:
                                              entity_id: !input thermostat
                                            data:
                                              temperature: !input comfort_temp
                                  - choose:
                                      - conditions:
                                          - condition: template
                                            value_template: "{{ current_temp >= comfort_temp }}"
                                        sequence:
                                          - action: climate.set_hvac_mode
                                            target:
                                              entity_id: !input thermostat
                                            data:
                                              hvac_mode: 'off'
                                    default: []
                              - conditions:
                                  - condition: template
                                    value_template: >
                                      {{ is_state(schedule_mo_fr, 'off') or
                                         is_state(schedule_sa_so, 'off') }}
                                sequence:
                                  - action: climate.set_hvac_mode
                                    target:
                                      entity_id: !input thermostat
                                    data:
                                      hvac_mode: heat
                                  - action: climate.set_temperature
                                    target:
                                      entity_id: !input thermostat
                                    data:
                                      temperature: !input setback_temp
                            default: []

                      # 4a-2) TRV-AUTO aktiv – HA greift nur minimal ein
                      - conditions:
                          - condition: template
                            value_template: "{{ use_trv_auto }}"
                        sequence:
                          - action: climate.set_hvac_mode
                            target:
                              entity_id: !input thermostat
                            data:
                              hvac_mode: auto

              # 4b) Fenster war offen -> schließt
              - conditions:
                  - condition: template
                    value_template: >
                      {{ window_sensor != [] and is_state(window_sensor, 'off') }}
                sequence:
                  - delay: !input window_close_delay
                  - condition: template
                    value_template: >
                      {{ window_sensor == [] or is_state(window_sensor, 'off') }}
                  - choose:
                      - conditions:
                          - condition: template
                            value_template: "{{ not use_trv_auto }}"
                        sequence:
                          - choose:
                              - conditions:
                                  - condition: template
                                    value_template: >
                                      {{ is_state(schedule_mo_fr, 'on') or
                                         is_state(schedule_sa_so, 'on') or
                                         (schedule_mo_fr == [] and schedule_sa_so == []) }}
                                sequence:
                                  - action: climate.set_hvac_mode
                                    target:
                                      entity_id: !input thermostat
                                    data:
                                      hvac_mode: heat
                                  - action: climate.set_temperature
                                    target:
                                      entity_id: !input thermostat
                                    data:
                                      temperature: "{{ last_comfort_temp }}"
                              - conditions:
                                  - condition: template
                                    value_template: >
                                      {{ is_state(schedule_mo_fr, 'off') or
                                         is_state(schedule_sa_so, 'off') }}
                                sequence:
                                  - action: climate.set_hvac_mode
                                    target:
                                      entity_id: !input thermostat
                                    data:
                                      hvac_mode: heat
                                  - action: climate.set_temperature
                                    target:
                                      entity_id: !input thermostat
                                    data:
                                      temperature: !input setback_temp
                            default: []
                      - conditions:
                          - condition: template
                            value_template: "{{ use_trv_auto }}"
                        sequence:
                          - action: climate.set_hvac_mode
                            target:
                              entity_id: !input thermostat
                            data:
                              hvac_mode: auto
            default: []
    default: []
